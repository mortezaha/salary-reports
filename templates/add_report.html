<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <title>{% if report %}ویرایش گزارش{% else %}ثبت گزارش جدید{% endif %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f8f9fa; }
        .navbar { background-color: #343a40; }
        .card-header { background-color: #0d6efd; color: white; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">گزارش حقوق و دستمزد</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="card">
            <div class="card-header">
                <h4>{% if report %}ویرایش گزارش{% else %}ثبت گزارش جدید{% endif %}</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('submit') }}">
                    {% if report %}
                    <input type="hidden" name="report_id" value="{{ report.id }}">
                    {% endif %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="province" class="form-label">استان</label>
                            <select name="province" id="province" class="form-select" required>
                                <option value="">انتخاب کنید...</option>
                                {% for province in provinces %}
                                    <option value="{{ province }}" {% if report and report.province == province %}selected{% endif %}>{{ province }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="unit_name" class="form-label">واحد/مرکز</label>
                            <select name="unit_name" id="unit_name" class="form-select" required>
                                <option value="">ابتدا استان را انتخاب کنید</option>
                                {% if report %}
                                <option value="{{ report.unit_name }}" selected>{{ report.unit_name }}</option>
                                {% endif %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="month" class="form-label">ماه</label>
                            <select name="month" id="month" class="form-select" required>
                                <option value="">انتخاب کنید...</option>
                                {% for month in months %}
                                    <option value="{{ month }}" {% if report and report.month == month %}selected{% endif %}>{{ month }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="year" class="form-label">سال</label>
                            <select name="year" id="year" class="form-select" required>
                                {% for year in years %}
                                    <option value="{{ year }}" {% if report and report.year == year %}selected{% elif not report and year == current_year %}selected{% endif %}>{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="staff_payment" class="form-label">درصد کارکنان</label>
                            <input type="text" class="form-control" id="staff_payment" name="staff_payment" placeholder="مثال: 95 یا 95%" value="{% if report %}{{ report.staff_payment }}{% endif %}">
                        </div>
                        <div class="col-md-4">
                            <label for="faculty_payment" class="form-label">درصد هیئت علمی</label>
                            <input type="text" class="form-control" id="faculty_payment" name="faculty_payment" placeholder="مثال: 98 یا 98%" value="{% if report %}{{ report.faculty_payment }}{% endif %}">
                        </div>
                        <div class="col-md-4">
                            <label for="arrears_payment" class="form-label">درصد معوقات</label>
                            <input type="text" class="form-control" id="arrears_payment" name="arrears_payment" placeholder="مثال: 100 یا 100%" value="{% if report %}{{ report.arrears_payment }}{% endif %}">
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">{% if report %}ویرایش گزارش{% else %}ثبت گزارش{% endif %}</button>
                            <a href="{{ url_for('index') }}" class="btn btn-secondary">انصراف</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const provinceSelect = document.getElementById('province');
        const unitSelect = document.getElementById('unit_name');

        const provinceUnits = {
            "همدان": ["همدان", "ملایر", "تویسرکان", "اسدآباد", "مرکز بهار", "مرکز کبودرآهنگ", "مرکز رزن", "مرکز قروه در گزین", "مرکز سامن"],
            "مرکزی": ["اراک", "ساوه", "آشتیان", "تفرش", "نراق", "کمیجان", "مرکز خنداب", "خمین", "محلات", "دلیجان", "زرندیه", "مرکز جاسب", "مرکز مهاجران", "مرکز شازند", "مرکز آستانه", "فراهان"],
            "کردستان": ["سنندج", "سقز", "مریوان", "قروه", "بیجار", "مرکز بانه"],
            "کرمانشاه": ["کرمانشاه", "اسلام آباد غرب", "کنگاور", "صحنه", "مرکز روانسر", "مرکز هرسین", "گیلانغرب", "مرکز قصر شیرین", "مرکز سنقر کلیایی"],
            "لرستان": ["واحد خرم آباد", "واحد بروجرد", "واحد الیگودرز", "واحد دورود"]
        };

        function updateUnits() {
            const selectedProvince = provinceSelect.value;
            console.log("استان انتخاب شده:", selectedProvince); // برای دیباگ

            // پاک کردن گزینه‌های قبلی
            unitSelect.innerHTML = '';

            if (selectedProvince && provinceUnits[selectedProvince]) {
                provinceUnits[selectedProvince].forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit;
                    option.textContent = unit;
                    unitSelect.appendChild(option);
                });
            } else {
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "ابتدا استان را انتخاب کنید";
                unitSelect.appendChild(defaultOption);
            }
        }

        provinceSelect.addEventListener('change', updateUnits);
        
        // در حالت ویرایش، واحدها را بر اساس استان موجود بارگذاری کن
        if (provinceSelect.value) {
            updateUnits();
        }
    });
    </script>
</body>
</html>